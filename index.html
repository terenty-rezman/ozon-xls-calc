<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <script src="https://cdn.jsdelivr.net/npm/danfojs@1.1.2/lib/bundle.min.js"></script>
<title>ozon xls calc</title>
</head>

<body>
    <div id="one"></div>
    <input type="file" id="file" name="file">
    <script>
        const inputFile = document.querySelector('#file');
        const one = document.querySelector('#one');
        let df; 
        let sku_names = {};
        let all_goods_sku; 

        let canceled_sells;
        let canceled_counts;

        let all_sells;
        let all_sells_counts = {};

        let delivered_sells;
        let delivered_counts = {};

        let sku_total = {};

        function calc_total_count_per_sku(rows) {
            let result_counts = {};

            for (let i = 0; i < all_goods_sku.shape[0]; i++) {
                let sku = all_goods_sku.iloc([i]).values[0];
                let count = rows.loc({rows: rows["SKU"].eq(sku)})
                    .column("Количество")
                    .sum();

                result_counts[sku] = count;
            }

            return result_counts;
        }

        function extract_names_for_sku(rows) {
            let skus = rows["SKU"].unique();
            let result_sku_names = {};

            for (let i = 0; i < skus.shape[0]; i++) {
                let sku = skus.iloc([i]).values[0];

                let article = rows.loc({rows: rows["SKU"].eq(sku)})
                    .column("Артикул").values[0];

                let name = rows.loc({rows: rows["SKU"].eq(sku)})
                    .column("Название товара или услуги").values[0];
                
                result_sku_names[sku] = `${name} ${article}`;
            }

            return result_sku_names;
        }

        inputFile.addEventListener("change", async () => {
            const excelFile = inputFile.files[0]
            // const columns_count = 17;

            // let dtypes = [
            //     "datetime", "string", "string", "datetime", "string", "int32", "string", "string"
            // ] 

            // rest columns are float32
            // for (let i = dtypes.length; i < 17; i++) {
            //     dtypes.push("float32");
            // }

            // dfd.readExcel(excelFile, {frameConfig: {dtypes: dtypes}}).then((ldf) => {
            dfd.readExcel(excelFile).then((ldf) => {
                df = ldf;

                all_sells = df.loc({ rows: df['Тип начисления'].eq('Оплата эквайринга') });

                all_goods_sku = all_sells["SKU"].unique();
                sku_names = extract_names_for_sku(all_sells);

                all_sells_counts = calc_total_count_per_sku(all_sells);

                canceled_sells = df.loc({ rows: df['Тип начисления'].eq('Доставка и обработка возврата, отмены, невыкупа') });
                canceled_counts = calc_total_count_per_sku(canceled_sells);

                console.log("отмены")
                for (const [sku, count] of Object.entries(canceled_counts)) {
                    let name = sku_names[sku];
                    console.log(`${name} ${sku}: ${count}`);
                }

                console.log("все продажи")
                for (const [sku, count] of Object.entries(all_sells_counts)) {
                    let name = sku_names[sku];
                    let cancels = canceled_counts[sku] || 0;
                    console.log(`${name} ${sku}: ${count - cancels}`, cancels, " отмен");
                }

                delivered_sells = df.loc(
                    { rows: df['Тип начисления'].eq('Доставка покупателю').and((df["За продажу или возврат до вычета комиссий и услуг"].gt(0))) }
                );

                delivered_counts = calc_total_count_per_sku(delivered_sells);

                console.log("доставленные")
                for (const [sku, count] of Object.entries(delivered_counts)) {
                    let name = sku_names[sku];
                    let cancels = canceled_counts[sku] || 0;
                    console.log(`${name} ${sku}: ${count - cancels}`, cancels, " отмен");
                }
            })
        })
         
    </script>
</body>

</html>
